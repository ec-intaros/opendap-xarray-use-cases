# Notebooks for analysing NetCDF data 

In this repository there are two notebooks for accessing, querying, analysing and visualising NetCDF data. The notebooks are explained in this document as separate sections, and can be executed in parallel. 

The two notebooks are:
1) **Test1 REF - OPeNDAP Xarray use cases**: a reference notebook for the download of a full data bulk, and ingesting it in a data structure in memory: this structure can be further filtered to extract data chunks, using Python functions, that are plotted for data visualisation;
2) **Test1 DAP - OPeNDAP Xarray use cases**: a Data Access Protocol (DAP) notebook for experimenting OPeNDAP query filters, for the download of directly optimized data chunks: these data chunks are then plotted for data visualisation.

Both the REF and DAP Notebooks follow the same approach: 
* Set-up
* Load and Plot of CTD Positions only (from DDS information)
* Load and Plot all needed CTD Data (from Variables and Attributes)

In each notebook, two case studies are described to visualise different data ranges: 
* extraction of data between the first elements of DEPTH, eg **0-20**;
* extraction of data between the last elements of DEPTH, eg **50-last**.

Application developers are supported to compare the two ways to querying data (Bulk and Optimized) in order to learn how to exploit efficiently (and without mistake) all the OPeNDAP server-side capabilities for data filtering and rerieval.


# 1) **Test1 REF - OPeNDAP Xarray use cases**

This Notebook provides an overview, as well as practical examples, to access and analyse a subset of NetCDF data from available campaigns collected in the year 2003. This subset of data has been prepared and uploaded on the Hyrax server (https://opendap.terradue.com/hyrax/data/subset_2003/), where it can be accessed directly.

The main steps for executing the Notebook are described below. 

## Exploratory Data Analysis

### Set-up
The first step is to define the url of the server to use. Two options are provided, one for HYRAX and one for THREDDS:
* hyrax: https://opendap.terradue.com/hyrax/data/subset_2003/
* thredds: https://opendap.terradue.com/thredds/dodsC/subset_2003/

Subsequently, the *year* and the *platform codes* are defined. This information is needed, and needs to be known a priori, as it allows comleting the url to access each specific NetCDF file. The naming convention of the NetCDF files is:
```58<platform_code>_CTD_<year>.nc.nc4```.
For example, for the platform 'GT' and year 2003, the name of the NetCDF file is: ```58GT_CTD_2003.nc.nc4.```

### Retrieval of DDS information
After the set-up, the data dimensions can be accessed through the Data Distribution Service (DDS), to understand the size of the datasets in an efficient way, without downloading all data into local memory. The dimensions under consideration for this NetCDF files are: 'TIME', 'LATITUDE', 'LONGITUDE', 'DEPTH', 'POSITION'.

### Visual Analysis: Load and Plot Positions only
The objective of this section is to visualise the geograhical positions of the data for each platform, and to perform some filtering operations based on locations and time queries. This is possible using only the necessary information retrieved from the DDS. The key dimensions that are used for the position analysis are: 'TIME', 'LATITUDE', 'LONGITUDE'. 

#### Create Position Dictionary and Dataframe 
The *position_dict* is a dictionary that is generated by iteratively reading the url of each platform, selecting only with 'TIME', 'LATITUDE', 'LONGITUDE' dimensions. In the dictionary are saved:
* the actual data, loaded into an xarray for data handling, analysis and visualisation
* the campaign's main attributes: *platform code & name*, *data type*, *title*, *instrument*, *longitude* & *latitude*, and *vertical min & max*)

A position dataframe is then generated per each platform, to match and combine the three 'TIME', 'LATITUDE', 'LONGITUDE' dimensions for each measurement. Subsequently, the platform-specific dataframes are combined in a *position_df* dataframe. An overview of the structure of the *position_df* dataframe is given below (showing the first and last 5 element):

Merged dataframe with all platforms. Total of 3209 measurement locations.
![image](./images/position_df_table.png)

#### Plot all Positions 
The positions of all measurements of the given platforms are visualised in different colours on an interactive plot. By hoovering on the coloured dots, information such as index, x&y, and platform can be easily retrieved and visualised. 

![image](./images/interactive_position_plot.png)

### Filter Positions
This section shows a few examples of data filtering by using the 'LATITUDE', 'LONGITUDE' and 'TIME' dimensions. The following filters are included:

* By bounding box (BBOX)
* By BBOX and Month of collection
* By BBOX and Time (eg hour) of collection
* By customised time range

## Data Processing: Load and Plot all Data (Variables and their Attributes)
This section goes deeper into the data analysis by accessing all data (variables and their attributes). This is therefore more computationally-demanding, especially if multiple datasets of many measurements are analysed at once. 

### Fetch Data 

#### Create Data Dictionary (*data_dict*) 
All data (variables and their attributes) for each platform are read iteratively, and saved into a dictionary *data_dict* which contains:
* the actual data, loaded into an xarray for data handling, analysis and visualisation
* the campaign's main attributes: *platform code & name*, *data type*, *title*, *instrument*, *longitude* & *latitude*, and *vertical min & max*)

#### Dataframe with overview of Platforms' attributes  
An overview dataframe *overview_df* is then generated to show the detailed information about each campaign at sea: *platform code & name*, *data type*, *title*, *instrument*, *longitude* & *latitude*, and *vertical min & max*).

#### Define Variables
The four variables that are available in this dataset are: 
* **PRES**: Sea Water Pressure
* **TEMP**: Sea Water Temperature
* **PSAL**: Sea Water Practical Salinity
* **CNDC**: Sea Water Electrical Conductivity

#### Define Filtered Data
Define the filtered dataframe to use for the analysis (eg *position_df_bbox*, *position_df_bbox_mm*, *position_df_bbox_hh*) to the **df_toPlot** variable.

### Range 0-20 Test
Define parameters:
* Platform Code
* Selected Variables
* DEPTH range

#### Data Filtering
This section allows filtering one or all variables for teh define platform and DEPTH range, to the previously-filtered data (eg by "BBOX", by "BBOX and Month", or by "BBOX and Hour").

The following are the two types of filters that are given as examples: 
* Filtered data by BBOX and One Variable
* Filtered data by BBOX (All Variables)

The output of both filters is a *filtered_xarr* xarray dataset, containing one or all the variables within the specified DEPTH range.

#### Reference Plots
The reference plots are generated for the available variables of the filtered xarrays. On the y-axis is shown the TIME of the measurement (in float format, which needs to be converted to datetime format), and on the x-axis is the DEPTH of the measurement. 

This notebook shows how to generate two types of plots:
* Plotting individual Variables per individual Platform
* Plotting individual Variables across aggregated Platforms

The first plot is more straightforward, as it automatically generates plot(s) of the variable(s) that has(have) been generated in the Data Filtering section. The example plots below represent the Sea Water Temperature and Pressure between 0-20 meters for the selected locations of the platform GT.
![image](./images/ref_0-20_individual.png)

The second plot is more complex, as it needs an additional operation before executing. This consists on generating and then aggregating all data across all platforms, for a specific variable. To do so, the dimensions of the DEPTH of the variables of all platforms must be equal, otherwise it is not possible to combine them into a new, aggregated, xarray. Two options are provided to accomplish this:
* Aggregate with minimum DEPTH elements, i.e. use minimum common DEPTH across all platforms' DEPTHs
* Aggregate with maximum DEPTH elements, i.e. use maximum DEPTH across all platforms' DEPTHs, and fill empty values with nans

The example plots below represent the four variables aggregated among the available platforms, between 0 and 100 meters below sea level.
![image](./images/ref_0-20_aggregated.png)

### Range 50-last Test
This section follows the same structure as the REF 0-20 range section, but focuses on data extracted from the 50 meters onwards of DEPTH.

* Plots for Sea Water Temperature and Pressure respectively, between 50-2956 meters for the selected locations of the platform GT.
![image](./images/ref_50-last_individual.png)
* Plots for Sea Water Temperature and Pressure respectively, between 50-2956 meters for the aggregated platforms.
![image](./images/ref_50-last_aggregated.png)


# 2) **Test1 DAP - OPeNDAP Xarray use cases** 
This Notebook provides a practical example to access and analyse **only a selection** of a NetCDF dataset that was presented in section *1) Test1 REF - OPeNDAP Xarray use cases*, to minimixe data volume requirements.

## Exploratory Data Analysis
This is the same as the *Exploratory Data Analysis* section in the REF Notebook. 

## Data Processing: Load and Plot selected Data (Variables within DEPTH range)
This section enables accessing data of **only selected variables** and **within a specified DEPTH range**, to avoid fetching unnecessary data and minimise data volume.

The selected variables of interest need to be specified in the *var_list*. The four variables that are available in this dataset are: 
* **PRES**: Sea Water Pressure
* **TEMP**: Sea Water Temperature
* **PSAL**: Sea Water Practical Salinity
* **CNDC**: Sea Water Electrical Conductivity 

The DEPTH range must also be defined in this case, as data is fetched with the specific DEPTH range directly from url. For some limitations to the DAP syntax, at least one range boundary needs to correspond to one of the two extremes. For example, in a data array of 100 elements starting from 0 to 99, the following scenarios are possible:
* select the first 20 elements, corresponding to the values range 0 - 19 --> ```[first:1:intermediate] (eg [0:1:19])``` work
* select the last 20 elements, corresponsing to the values range 80 - 99 --> ```[intermediate:1:last] (eg [80:1:99])``` work
* select the intermediate 60-80 elements, corresponsing to the values range 60 - 79 --> ```[intermediate_1:1:intermediate_2] (eg [80:1:89])``` does NOT work

### Range 0-20 Test

#### Create Data Dictionary (*data_dict*) 
Define Selected Variables and then the DEPTH range, noting that:
* ***metadata[pc]['depth_m_v1']***: either this is equal to the lower bound (ie index=0)
* ***metadata[pc]['depth_m_v2']***: or is equal to the upper bound (ie index=-1)

Once variables and depth range are defined, the data and their attributes are read iteratively for each platform, and saved into a dictionary *data_dict*, similarily as described in the REF notebook. 

#### Define Filtered Data
Define the filtered dataframe to use for the analysis (eg *position_df_bbox*, *position_df_bbox_mm*, *position_df_bbox_hh*) to the **df_toPlot** variable.

#### Data Filtering
This is the same as the *Data Filtering* section in the REF Notebook. 

#### Reference Plots
The reference plots are generated in the same way as decribed in the REF Notebook. 
* Plots for Sea Water Temperature and Pressure respectively, between 0-20 meters for the selected locations of the platform GT.
![image](./images/dap_0-20_individual.png)
* Plots for Sea Water Temperature and Pressure respectively, between 0-20 meters, for the selected locations of the aggregated platforms.
![image](./images/dap_0-20_aggregated.png)


### Range 50-last Test
This section follows the same structure as the DAP 0-20 range section, but focuses on data extracted from the 50 meters onwards of DEPTH.

* Plot for Sea Water Temperature and Pressure respectively, between 50-2956 meters for the selected locations of the platform GT.
![image](./images/dap_50-last_individual.png)

* Plot for Sea Water Temperature and Pressure respectively, between 50-2956 meters for the aggregated platforms.
![image](./images/dap_50-last_aggregated.png)