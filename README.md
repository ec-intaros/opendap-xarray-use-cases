# Notebooks for analysing NetCDF data 

In this repository there are two notebooks for accessing, querying, analysing and visualising NetCDF data. The notebooks are explained in this document as separate sections, and can be executed in parallel. 

The two notebooks are:
* 1) **Test1 REF - OPeNDAP Xarray use cases**: a reference notebook for the download of a full data bulk, and ingesting it in a data structure in memory: this structure can be further filtered to extract data chunks, using Python functions, that are plotted for data visualisation;
* 2) **Test1 DAP - OPeNDAP Xarray use cases**: a Data Access Protocol (DAP) notebook for experimenting OPeNDAP query filters, for the download of directly optimized data chunks: these data chunks are then plotted for data visualisation.

Both the REF and DAP Notebooks follow the same structure: 
* Exploratory Data Analysis
* 




In each notebook, two case studies are shown to visualise data: 
* extraction of data between the first 20 element of DEPTH (0-20)
* extraction of data between the last elements of DEPTH, from the 50th element onwards (50-last)

# 1) Test1 REF - Comparison

This Notebook provides an overview, as well as practical examples, to access and analyse a subset of NetCDF data from available campaigns collected in the year 2003. This subset of data has been prepared and uploaded on the Hyrax server (https://opendap.terradue.com/hyrax/data/subset_2003/), where it can be accessed directly.

The main steps for executing the Notebook are described below. 

## Exploratory Data Analysis

### Set-up
The first step is to define the url of the server to use. Two options are provided, one for HYRAX and one for THREDDS:
* hyrax: https://opendap.terradue.com/hyrax/data/subset_2003/
* thredds: https://opendap.terradue.com/thredds/dodsC/subset_2003/

Subsequently, the *year* and the *platform codes* are defined. This information is needed, and needs to be known a priori, as it allows comleting the url to access each specific NetCDF file. The naming convention of the NetCDF files is:
```58<platform_code>_CTD_<year>.nc.nc4```.
For example, for the platform 'GT' and year 2003, the name of the NetCDF file is: ```58GT_CTD_2003.nc.nc4.```

### Retrieval of DDS information
After the set-up, the data dimensions can be accessed through the Data Distribution Service (DDS), to understand the size of the datasets in an efficient way, without downloading all data into local memory. The dimensions under consideration for this NetCDF files are: 'TIME', 'LATITUDE', 'LONGITUDE', 'DEPTH', 'POSITION'.

### Visual Analysis: Load and Plot Positions only
The objective of this section is to visualise the geograhical positions of the data for each platform, and to perform some filtering operations based on locations and time queries. This is possible using only the necessary information retrieved from the DDS. The key dimensions that are used for the position analysis are: 'TIME', 'LATITUDE', 'LONGITUDE'. 

#### Create Position Dictionary and Dataframe 
The *position_dict* is a dictionary that is generated by iteratively reading the url of each platform, selecting only with 'TIME', 'LATITUDE', 'LONGITUDE' dimensions. In the dictionary are saved:
* the actual data, loaded into an xarray for data handling, analysis and visualisation
* the campaign's main attributes: *platform code & name*, *data type*, *title*, *instrument*, *longitude* & *latitude*, and *vertical min & max*)

A position dataframe is then generated per each platform, to match and combine the three 'TIME', 'LATITUDE', 'LONGITUDE' dimensions for each measurement. Subsequently, the platform-specific dataframes are combined in a *position_df* dataframe. An overview of the structure of the *position_df* dataframe is given below (showing the first and last 5 element):

Merged dataframe with all platforms. Total of 3209 measurement locations.
![image](./images/position_df_table.png)

#### Plot all Positions 
The positions of all measurements of the given platforms are visualised in different colours on an interactive plot. By hoovering on the coloured dots, information such as index, x&y, and platform can be easily retrieved and visualised. 

![image](./images/interactive_position_plot.png)

### Filter Positions
This section shows a few examples of data filtering by using the 'LATITUDE', 'LONGITUDE' and 'TIME' dimensions. The following filters are included:

* By bounding box (BBOX)
* By BBOX and Month of collection
* By BBOX and Time (eg hour) of collection
* By customised time range

## Data Processing: Load and Plot all Data (Variables and their Attributes)
This section goes deeper into the data analysis by accessing all data (variables and their attributes). This is therefore more computationally-demanding, especially if multiple datasets of many measurements are analysed at once. 

### Fetch Data 

#### Create Data Dictionary (*data_dict*) 
All data (variables and their attributes) for each platform are read iteratively, and saved into a dictionary *data_dict* which contains:
* the actual data, loaded into an xarray for data handling, analysis and visualisation
* the campaign's main attributes: *platform code & name*, *data type*, *title*, *instrument*, *longitude* & *latitude*, and *vertical min & max*)

#### Dataframe with overview of Platforms' attributes  
An overview dataframe *overview_df* is then generated to show the detailed information about each campaign at sea: *platform code & name*, *data type*, *title*, *instrument*, *longitude* & *latitude*, and *vertical min & max*).

#### Define Variables
The four variables that are available in this dataset are: 
* **PRES**: Sea Water Pressure
* **TEMP**: Sea Water Temperature
* **PSAL**: Sea Water Practical Salinity
* **CNDC**: Sea Water Electrical Conductivity

#### Define Filtered Data
Define the filtered dataframe to use for the analysis (eg *position_df_bbox*, *position_df_bbox_mm*, *position_df_bbox_hh*) to the **df_toPlot** variable.

### Range 0-20 Test







#### Filter Data
This section allows filtering one or more variables for each platform, and DEPTH range, to the data that was previously filtered in the Filtered Position section.

The following are the four types of filters that are given as examples: 
* Filtered data by BBOX and One Variable
* Filtered data by BBOX (All Variables)
* Filtered data by BBOX and One Variable, within a DEPTH range
* Filtered data by BBOX (All Variables), within a DEPTH range

The output of all filters is a *filtered_xarr* xarray dataset, containing one or all the variables within the specified DEPTH range, of those positions that have been previously filtered (eg by "BBOX", by "BBOX and Month", or by "BBOX and Hour"). 

#### Reference Plots
The reference plots are generated for the available variables of the filtered xarrays. On the y-axis is shown the TIME of the measurement (in float format, which needs to be converted to datetime format), and on the x-axis is the DEPTH of the measurement. 

This notebook shows how to generate two types of plots:
* Plotting individual Variables per individual Platform
* Plotting individual Variables across aggregated Platforms

The first plot is more straightforward, as it automatically generates plot(s) of the variable(s) that has(have) been generated in the Filtered Data section. The example plot below represents the Sea Water Practical Salinity (PSAL) between 50 and 100 meters below sea level, for the platform GT.
![image](./images/GT_PSAL.png)

The second plot is more complex, as it needs an additional operation before executing. This consists on generating and then aggregating all data for a specific variable, across all platforms. To do so, the dimensions of the DEPTH of the variables of all platforms must be the equal, otherwise it is not possible to combine them into a new, aggregated, xarray. Two options are provided to accomplish this:
* Aggregate with minimum DEPTH, i.e. use minimum common DEPTH across all platforms' DEPTHs
* Aggregate with maximum DEPTH, i.e. use maximum DEPTH across all platforms' DEPTHs, and fill empty values with nans

The example plots below represent the four variables aggregated among the available platforms, between 0 and 100 meters below sea level.
![image](./images/aggregated_platforms.png)


## 2) DAP Notebook - Extraction with Queries 
This Notebook provides a practical example to access and analyse **only a selection** of a NetCDF dataset that was presented in section *1) Reference Notebook - Subset 2003 Analysis with Xarray*, to minimixe data volume requirements.

### Set-up
same as relevant section in ## 1) Reference Notebook - Subset 2003 Analysis with Xarray

### Retrieval of DDS information
same as relevant section in ## 1) Reference Notebook - Subset 2003 Analysis with Xarray

### Visual Analysis: Load and Plot Positions only
same as relevant section in ## 1) Reference Notebook - Subset 2003 Analysis with Xarray

#### Create Position Dictionary and Dataframe 
same as relevant section in ## 1) Reference Notebook - Subset 2003 Analysis with Xarray

#### Plot Positions 
same as relevant section in ## 1) Reference Notebook - Subset 2003 Analysis with Xarray

#### Filter Positions
same as relevant section in ## 1) Reference Notebook - Subset 2003 Analysis with Xarray

### Processing: Load and Plot selected Data (Variables within DEPTH range)
This section enables accessing data of **only selected variables** and **within a specified DEPTH range**, to avoid fetching unnecessary data and minimise data volume.

The selected variables of interest need to be specified in the *var_list*. The four variables that are available in this dataset are: 
* **PRES**: Sea Water Pressure
* **TEMP**: Sea Water Temperature
* **PSAL**: Sea Water Practical Salinity
* **CNDC**: Sea Water Electrical Conductivity 

The depth range must also be defined. For some limitations to the DAP syntax, at least one boundary needs to correspond to one of the two extremes, ie ```[2:1:4]``` does NOT work, but ```[0:1:4]``` or ```[4:1:last]``` work.

#### Create Data Dictionary (*data_dict*) 
Once variables and depth range are defined, the data and their attributes are read iteratively for each platform, and saved into a dictionary *data_dict* which contains:
* the actual data, loaded into an **xarray** for data handling, analysis and visualisation
* the campaign's main attributes: platform code & name, data type, title, instrument, longitude & latitude, and vertical min & max)  

An overview dataframe *overview_df* is then generated to show the detailed information about each campaign at sea: *platform code & name*, *data type*, *title*, *instrument*, *longitude* & *latitude*, and *vertical min & max*).

#### Define DEPTH range for analysis
The selected values of DEPTH are defined within the range *depth_start* - *common_depth_stop_abs*. 
* *depth_start*: this is defined when the data vars are fetched. if it's 0, then depth_stop can either be to the last value of each platform (ie ALL data), or a set constant eg 10
* *common_depth_stop_abs*: this is the absolute maximum value of depth, ie aligned with the actual measurements of depth   

#### Filter Data
This section allows filtering one or more variables for each platform, with a desired DEPTH range, to the data that was previously filtered in the Filtered Position section (eg by "BBOX", by "BBOX and Month", or by "BBOX and Hour"). 

The following are the two types of filters that are given as examples: 
* Filtered data by BBOX and One Variable
* Filtered data by BBOX (All Variables)

The output of both filters is a *filtered_xarr* xarray dataset, containing one or all the variables within the specified DEPTH range.  

#### Reference Plots
The reference plots are generated for the available **variables** of the **filtered** xarrays. On the y-axis is shown the TIME of the measurement (in float format, which needs to be converted to datetime format), and on the x-axis is the DEPTH of the measurement. 

This notebook shows how to generate two types of plots:
* Plotting individual Variables per individual Platform
* Plotting individual Variables across aggregated Platforms

The first plot is more straightforward, as it automatically generates plot(s) of the variable(s) that has(have) been generated in the Filtered Data section. The example plots below represent the Sea Water Temperature (TEMP) and Pressure (PRES) respectively, between 200 and 280 meters below sea level, for the platform AA.
![image](./images/Plotting_Variables_per_individual_Platform.png)

The second plot is more complex, as it needs an additional operation before executing. This consists on generating and then aggregating all data for individual variable(s), across available platforms. To do so, the **Filtered data by BBOX (All Variables)** section must have been executed, so that the correct *filtered_arr* array is used. 

The example plots below represent the two variables TEMP and PRES aggregated among the available platforms, between 200 and 280 meters below sea level.
![image](./images/Plotting_aggregate_results.png)
